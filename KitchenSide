// KitchenScreen.js - Complete with Working Toggle
import React, { useState, useEffect, useCallback } from "react";
import {
  SafeAreaView,
  ScrollView,
  Text,
  StyleSheet,
  View,
  TouchableOpacity,
  Alert,
  RefreshControl,
  ActivityIndicator,
  StatusBar,
  Modal,
  TextInput,
} from "react-native";
import { createClient } from "@supabase/supabase-js";

// Supabase Configuration
const SUPABASE_URL = "https://tbfhhplpwqelstuzmlmh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiZmhocGxwd3FlbHN0dXptbG1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0ODY0NzYsImV4cCI6MjA3OTA2MjQ3Nn0.7v1snYLBqDEvNfGS9D74j_CqAUteZSI7oZxKrPFifPw";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Constants
const KITCHEN_ID = 'fe7566a9-948e-49a5-99a0-fce471acb649';

const Colors = {
  primary: "#00ff00",
  secondary: "#32CD32",
  danger: "#ff4444",
  warning: "#FFA500",
  background: "#1a1a1a",
  card: "#2d2d2d",
  text: "#ffffff",
  textSecondary: "#aaaaaa",
  success: "#00cc00",
  error: "#cc0000",
};

// Kitchen Toggle Component
const KitchenToggle = ({ isOpen, onToggle, isLoading }) => (
  <TouchableOpacity
    style={[
      styles.kitchenToggle,
      { 
        backgroundColor: isOpen ? Colors.success : Colors.error,
        opacity: isLoading ? 0.6 : 1
      }
    ]}
    onPress={onToggle}
    disabled={isLoading}
  >
    <Text style={styles.kitchenToggleText}>
      {isOpen ? "üè™ KITCHEN OPEN" : "üö´ KITCHEN CLOSED"}
    </Text>
    {isLoading && (
      <ActivityIndicator size="small" color={Colors.text} style={styles.toggleSpinner} />
    )}
  </TouchableOpacity>
);

// Order Card Component
const OrderCard = ({ order, onComplete, onDecline }) => {
  const formatTime = (timestamp) => {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  };

  const orderItems = Array.isArray(order.order_items) ? order.order_items : [];

  return (
    <View style={styles.kitchenOrderCard}>
      <View style={styles.orderHeader}>
        <Text style={styles.orderId}>Order #{order.id}</Text>
        <View style={[styles.statusBadge, { backgroundColor: Colors.warning }]}>
          <Text style={styles.statusText}>NEW</Text>
        </View>
      </View>

      <Text style={styles.customerName}>
        üë§ {order.customer_name || "Customer"}
      </Text>

      <View style={styles.itemsSection}>
        <Text style={styles.itemsLabel}>Items:</Text>
        {orderItems.length > 0 ? (
          orderItems.map((item, index) => (
            <View key={index} style={styles.itemRow}>
              <Text style={styles.itemName}>‚Ä¢ {item.name}</Text>
              <Text style={styles.itemPrice}>${item.price}</Text>
            </View>
          ))
        ) : (
          <Text style={styles.noItemsText}>No items available</Text>
        )}
      </View>

      <View style={styles.orderFooter}>
        <Text style={styles.totalAmount}>
          Total: ${parseFloat(order.total_price || 0).toFixed(2)}
        </Text>
        
        <View style={styles.actionButtons}>
          <TouchableOpacity
            style={[styles.actionButton, styles.completeButton]}
            onPress={() => onComplete(order.id)}
          >
            <Text style={styles.actionButtonText}>‚úÖ Complete</Text>
          </TouchableOpacity>

          <TouchableOpacity
            style={[styles.actionButton, styles.declineButton]}
            onPress={() => onDecline(order)}
          >
            <Text style={styles.actionButtonText}>‚ùå Decline</Text>
          </TouchableOpacity>
        </View>
      </View>
    </View>
  );
};

// Main Kitchen Screen
const KitchenScreen = () => {
  const [orders, setOrders] = useState([]);
  const [isKitchenOpen, setIsKitchenOpen] = useState(true);
  const [isLoading, setIsLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [isTogglingKitchen, setIsTogglingKitchen] = useState(false);
  const [showDeclineModal, setShowDeclineModal] = useState(false);
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [declineReason, setDeclineReason] = useState("");

  // Load kitchen status
  const loadKitchenStatus = useCallback(async () => {
    try {
      const { data, error } = await supabase
        .from("Kitchens")
        .select("is_open")
        .eq("id", KITCHEN_ID)
        .single();

      if (error) {
        console.log("Kitchen not found, creating...");
        const { data: newKitchen, error: createError } = await supabase
          .from("Kitchens")
          .insert([{ 
            id: KITCHEN_ID,
            name: "Main Kitchen", 
            is_open: true,
            created_at: new Date().toISOString()
          }])
          .select()
          .single();

        if (createError) {
          console.error("Error creating kitchen:", createError);
          return;
        }

        setIsKitchenOpen(newKitchen.is_open);
        return;
      }

      if (data) {
        setIsKitchenOpen(data.is_open);
      }
    } catch (error) {
      console.error("Error loading kitchen status:", error);
    }
  }, []);

  // Load orders
  const loadOrders = useCallback(async () => {
    try {
      const { data, error } = await supabase
        .from("orders")
        .select("*")
        .eq("kitchen_id", KITCHEN_ID)
        .neq("status", "completed")
        .neq("status", "declined")
        .order("created_at", { ascending: true });

      if (!error) {
        setOrders(data || []);
      } else {
        console.error("Error loading orders:", error);
      }
    } catch (error) {
      console.error("Error loading orders:", error);
    } finally {
      setIsLoading(false);
      setIsRefreshing(false);
    }
  }, []);

  // Refresh data
  const refreshData = useCallback(async () => {
    setIsRefreshing(true);
    await Promise.all([loadOrders(), loadKitchenStatus()]);
  }, [loadOrders, loadKitchenStatus]);

  // Toggle kitchen status - SIMPLE VERSION
  const toggleKitchen = useCallback(async () => {
    setIsTogglingKitchen(true);
    const newState = !isKitchenOpen;

    try {
      const { error } = await supabase
        .from("Kitchens")
        .update({ 
          is_open: newState,
          updated_at: new Date().toISOString()
        })
        .eq("id", KITCHEN_ID);

      if (error) throw error;

      setIsKitchenOpen(newState);
      
      Alert.alert(
        "Success",
        `Kitchen is now ${newState ? "OPEN" : "CLOSED"}`,
        [{ text: "OK" }]
      );
      
    } catch (error) {
      console.error("Error toggling kitchen:", error);
      Alert.alert("Error", "Failed to update kitchen status");
    } finally {
      setIsTogglingKitchen(false);
    }
  }, [isKitchenOpen]);

  // Complete order
  const completeOrder = async (orderId) => {
    try {
      await supabase
        .from('orders')
        .update({ status: 'completed' })
        .eq('id', orderId);
      
      setOrders(prev => prev.filter(order => order.id !== orderId));
      
      Alert.alert("Order Completed!", `Order #${orderId} completed.`);
    } catch (error) {
      console.error("Error completing order:", error);
      Alert.alert("Error", "Failed to complete order");
    }
  };

  // Decline order
  const declineOrder = async (orderId, reason) => {
    if (!reason.trim()) {
      Alert.alert("Error", "Please provide a reason");
      return;
    }

    try {
      await supabase
        .from('orders')
        .update({ 
          status: 'declined',
          cancelled_reason: reason 
        })
        .eq('id', orderId);
      
      setOrders(prev => prev.filter(order => order.id !== orderId));
      
      Alert.alert("Order Declined!", `Order #${orderId} declined.`);
    } catch (error) {
      console.error("Error declining order:", error);
      Alert.alert("Error", "Failed to decline order");
    }
  };

  // Modal functions
  const openDeclineModal = (order) => {
    setSelectedOrder(order);
    setShowDeclineModal(true);
    setDeclineReason("");
  };

  const closeDeclineModal = () => {
    setShowDeclineModal(false);
    setSelectedOrder(null);
    setDeclineReason("");
  };

  const handleDeclineConfirm = () => {
    if (selectedOrder) {
      declineOrder(selectedOrder.id, declineReason);
      closeDeclineModal();
    }
  };

  // Effects
  useEffect(() => {
    refreshData();
  }, [refreshData]);

  useEffect(() => {
    const orderSubscription = supabase
      .channel('orders')
      .on('postgres_changes', 
        { 
          event: '*', 
          schema: 'public', 
          table: 'orders',
          filter: `kitchen_id=eq.${KITCHEN_ID}`
        }, 
        () => {
          loadOrders();
        }
      )
      .subscribe();

    const kitchenSubscription = supabase
      .channel('kitchens')
      .on('postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'Kitchens',
          filter: `id=eq.${KITCHEN_ID}`
        },
        () => {
          loadKitchenStatus();
        }
      )
      .subscribe();

    return () => {
      orderSubscription.unsubscribe();
      kitchenSubscription.unsubscribe();
    };
  }, [loadOrders, loadKitchenStatus]);

  return (
    <SafeAreaView style={styles.container}>
      <StatusBar barStyle="light-content" backgroundColor={Colors.background} />
      
      <ScrollView
        contentContainerStyle={styles.scrollContent}
        refreshControl={
          <RefreshControl
            refreshing={isRefreshing}
            onRefresh={refreshData}
            colors={[Colors.primary]}
            tintColor={Colors.primary}
          />
        }
      >
        <Text style={styles.title}>üßë‚Äçüç≥ KITCHEN DISPLAY</Text>

        {/* Kitchen Toggle */}
        <KitchenToggle
          isOpen={isKitchenOpen}
          onToggle={toggleKitchen}
          isLoading={isTogglingKitchen}
        />

        {/* Kitchen Info */}
        <View style={styles.kitchenInfo}>
          <Text style={styles.kitchenStatus}>
            Status: {isKitchenOpen ? "üü¢ OPEN" : "üî¥ CLOSED"}
          </Text>
        </View>

        {/* Orders Counter */}
        <View style={styles.statsContainer}>
          <View style={styles.statItem}>
            <Text style={styles.statNumber}>{orders.length}</Text>
            <Text style={styles.statLabel}>Active Orders</Text>
          </View>
        </View>

        {/* Orders List */}
        {isLoading ? (
          <View style={styles.loadingContainer}>
            <ActivityIndicator size="large" color={Colors.primary} />
            <Text style={styles.loadingText}>Loading orders...</Text>
          </View>
        ) : orders.length === 0 ? (
          <View style={styles.emptyState}>
            <Text style={styles.emptyStateEmoji}>üì≠</Text>
            <Text style={styles.emptyStateText}>No active orders</Text>
            <Text style={styles.emptyStateSubtext}>
              {isKitchenOpen 
                ? "New orders will appear here automatically" 
                : "Kitchen is closed"
              }
            </Text>
          </View>
        ) : (
          orders.map((order) => (
            <OrderCard
              key={order.id}
              order={order}
              onComplete={completeOrder}
              onDecline={openDeclineModal}
            />
          ))
        )}
      </ScrollView>

      {/* Decline Modal */}
      <Modal
        visible={showDeclineModal}
        animationType="slide"
        transparent={true}
        onRequestClose={closeDeclineModal}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>Decline Order</Text>
            <Text style={styles.modalSubtitle}>
              Order #{selectedOrder?.id}
            </Text>
            
            <TextInput
              style={styles.reasonInput}
              placeholder="Reason for declining..."
              value={declineReason}
              onChangeText={setDeclineReason}
              multiline
              numberOfLines={4}
            />
            
            <View style={styles.modalActions}>
              <TouchableOpacity
                style={[
                  styles.confirmButton,
                  !declineReason.trim() && styles.disabledButton,
                ]}
                onPress={handleDeclineConfirm}
                disabled={!declineReason.trim()}
              >
                <Text style={styles.confirmButtonText}>Confirm</Text>
              </TouchableOpacity>
              
              <TouchableOpacity
                style={styles.cancelButton}
                onPress={closeDeclineModal}
              >
                <Text style={styles.cancelButtonText}>Cancel</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </SafeAreaView>
  );
};

// Styles
const styles = StyleSheet.create({
  container: { 
    flex: 1, 
    backgroundColor: Colors.background 
  },
  scrollContent: { 
    padding: 16,
    paddingBottom: 20 
  },
  title: {
    fontSize: 28,
    fontWeight: "bold",
    color: Colors.primary,
    textAlign: "center",
    marginBottom: 20,
  },
  kitchenInfo: {
    backgroundColor: Colors.card,
    padding: 16,
    borderRadius: 8,
    marginBottom: 16,
  },
  kitchenStatus: {
    color: Colors.text,
    fontSize: 16,
    textAlign: "center",
    fontWeight: "bold",
  },
  kitchenToggle: {
    padding: 16,
    borderRadius: 12,
    alignItems: "center",
    marginBottom: 20,
    flexDirection: "row",
    justifyContent: "center",
  },
  kitchenToggleText: { 
    color: Colors.text, 
    fontSize: 18, 
    fontWeight: "bold",
    marginRight: 8,
  },
  toggleSpinner: {
    marginLeft: 8,
  },
  statsContainer: {
    flexDirection: "row",
    justifyContent: "center",
    marginBottom: 20,
    backgroundColor: Colors.card,
    padding: 16,
    borderRadius: 12,
  },
  statItem: {
    alignItems: "center",
  },
  statNumber: {
    fontSize: 32,
    fontWeight: "bold",
    color: Colors.primary,
    marginBottom: 4,
  },
  statLabel: {
    fontSize: 16,
    color: Colors.textSecondary,
    fontWeight: "600",
  },
  kitchenOrderCard: {
    backgroundColor: Colors.card,
    padding: 16,
    marginBottom: 12,
    borderRadius: 12,
  },
  orderHeader: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
    marginBottom: 12,
  },
  orderId: { 
    fontSize: 18, 
    color: Colors.text, 
    fontWeight: "bold" 
  },
  statusBadge: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
  },
  statusText: {
    fontSize: 10,
    color: Colors.text,
    fontWeight: "bold",
  },
  customerName: { 
    color: Colors.text, 
    fontSize: 16, 
    marginBottom: 12,
    fontWeight: "600",
  },
  itemsSection: { 
    marginBottom: 12 
  },
  itemsLabel: { 
    color: Colors.textSecondary, 
    marginBottom: 8,
    fontWeight: "600",
  },
  itemRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    marginBottom: 4,
  },
  itemName: { 
    color: Colors.text, 
    fontSize: 14,
  },
  itemPrice: {
    color: Colors.textSecondary,
    fontSize: 14,
  },
  noItemsText: {
    color: Colors.textSecondary,
    fontSize: 14,
    fontStyle: 'italic',
  },
  orderFooter: {
    borderTopWidth: 1,
    borderTopColor: Colors.textSecondary,
    paddingTop: 12,
  },
  totalAmount: {
    color: Colors.primary,
    fontSize: 18,
    fontWeight: "bold",
    marginBottom: 12,
    textAlign: "center",
  },
  actionButtons: { 
    flexDirection: "row", 
    gap: 8 
  },
  actionButton: {
    flex: 1,
    padding: 12,
    borderRadius: 8,
    alignItems: "center",
  },
  completeButton: {
    backgroundColor: Colors.success,
  },
  declineButton: {
    backgroundColor: Colors.error,
  },
  actionButtonText: { 
    color: Colors.text, 
    fontWeight: "bold",
    fontSize: 14,
  },
  emptyState: { 
    alignItems: "center", 
    marginTop: 50 
  },
  emptyStateEmoji: {
    fontSize: 48,
    marginBottom: 16,
  },
  emptyStateText: { 
    color: Colors.textSecondary, 
    fontSize: 20,
    marginBottom: 8,
  },
  emptyStateSubtext: {
    color: Colors.textSecondary,
    fontSize: 14,
    textAlign: "center",
  },
  loadingContainer: {
    alignItems: "center",
    justifyContent: "center",
    padding: 40,
  },
  loadingText: {
    color: Colors.textSecondary,
    marginTop: 12,
    fontSize: 16,
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: "rgba(0,0,0,0.5)",
    justifyContent: "center",
    alignItems: "center",
    padding: 20,
  },
  modalContent: {
    backgroundColor: "white",
    padding: 24,
    borderRadius: 12,
    width: "100%",
  },
  modalTitle: {
    fontSize: 20,
    fontWeight: "bold",
    marginBottom: 8,
    color: "#333",
    textAlign: "center",
  },
  modalSubtitle: {
    fontSize: 16,
    color: "#666",
    marginBottom: 16,
    textAlign: "center",
  },
  reasonInput: {
    borderWidth: 1,
    borderColor: "#ddd",
    borderRadius: 8,
    padding: 12,
    textAlignVertical: "top",
    minHeight: 120,
    marginBottom: 20,
  },
  modalActions: {
    flexDirection: "row",
    gap: 12,
  },
  confirmButton: {
    flex: 1,
    backgroundColor: "#dc3545",
    padding: 12,
    borderRadius: 8,
    alignItems: "center",
  },
  disabledButton: {
    backgroundColor: "#6c757d",
  },
  confirmButtonText: {
    color: "white",
    fontWeight: "bold",
    fontSize: 16,
  },
  cancelButton: {
    flex: 1,
    backgroundColor: "#6c757d",
    padding: 12,
    borderRadius: 8,
    alignItems: "center",
  },
  cancelButtonText: {
    color: "white",
    fontWeight: "bold",
    fontSize: 16,
  },
});

export default KitchenScreen;
